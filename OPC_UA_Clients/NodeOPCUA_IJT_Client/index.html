<!DOCTYPE html>
<HTML lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>OPC UA IJT Demo</title>
  <link rel='stylesheet' type='text/css' href='nodeStyle.css'>
</head>

<link rel='icon' type='image/png' href='../Resources/trussIcon.png' />

<body>
  <div id='connectedServer' class='connectedServer'>
    <label>Server name: </label>
    <label id='displayedServerName' class='connectedServerName'>Unconnected</label>
  </div>

  <script src='/socket.io/socket.io.js'></script>

  <script type='module'>
    import ModelManager from './Javascripts/Models/ModelManager.mjs'
    import TabGenerator from './Javascripts/WebPage/TabGenerator/TabGenerator.mjs'
    import IJTBaseModel from './Javascripts/Models/IJTBaseModel.mjs'
    import AllTraces from './Javascripts/WebPage/Trace/AllTraces.mjs'
    import ServerGraphics from './Javascripts/WebPage/Servers/ServerGraphics.mjs'
    import NodeGraphics from './Javascripts/WebPage/Structure/NodeGraphics.mjs'
    import AddressSpace from './Javascripts/WebPage/Structure/AddressSpace.mjs'
    import AssetHandler from './Javascripts/WebPage/Assets/AssetHandler.mjs'
    import SocketHandler from './Javascripts/WebPage/SocketHandler/SocketHandler.mjs'
    import EventManager from './Javascripts/WebPage/Events/EventManager.mjs'
    import EventGraphics from './Javascripts/WebPage/Events/EventGraphics.mjs'
    import MethodGraphics from './Javascripts/WebPage/Methods/MethodGraphics.mjs'
    import MethodManager from './Javascripts/WebPage/Methods/MethodManager.mjs'
    

    // Set up essentials
    var socket = io()
    var tabGenerator = new TabGenerator(document.body)
    var socketHandler = new SocketHandler(socket)
    var modelManager = new ModelManager()

    // Initiate the different tab handlers
    var servers = new ServerGraphics(tabGenerator.generateTab('Servers'), socketHandler)
    var addressSpace = new AddressSpace(socketHandler)
    var nodeGraphics = new NodeGraphics(tabGenerator.generateTab('Nodes', true), socketHandler, addressSpace)
    var eventGraphics = new EventGraphics (tabGenerator.generateTab('Events'), socketHandler)
    var eventManager = new EventManager(modelManager, eventGraphics);
    let assetHandler = new AssetHandler(tabGenerator.generateTab('Assets'), addressSpace, socketHandler)
    let trace = new AllTraces(tabGenerator.generateTab('Trace'), ['angle', 'torque'], addressSpace)
    let methodGraphics = new MethodGraphics(tabGenerator.generateTab('Methods'))
    const methodManager = new MethodManager(socketHandler, methodGraphics)
   
    /*****************  Set up socket listeners to handle input from server *******************/

    // Listen to the data from the server regarding the tree of queriable data and display it
    socketHandler.registerMandatory('browseresult', function (msg) {
      return addressSpace.addNodeByBrowse(msg)
    })

    // Listen to result data and convert it into a javascript model then display it
    socketHandler.registerMandatory('readresult', function (msg) {
      if (!msg) {
        return
      }
      let node = addressSpace.addNodeByRead(msg)
      if (node) {
        let model = modelManager.createModelFromNode(node)
        nodeGraphics.displayModel(model)
      }
      return node
    })

    // Listen to subscribed events messages
    socketHandler.registerMandatory('subscribed event', function (msg, context) {
      let model = eventManager.interpretMessage(msg)
      
    })

    // Listen to subscribed events messages
    socketHandler.registerMandatory('callresult', function (msg) {
    })

    // Listen to status messages from Node-OPCUA
    socketHandler.registerMandatory('status message', function (msg) {
      servers.messageDisplay(msg)
    })

    // Listen to the tree of possible connection points (Available OPC UA servers)
    socketHandler.registerMandatory('connection points', function (msg) {
      servers.connectionPoints(msg, socket)
    })

    // Listen to connection
    socketHandler.registerMandatory('connection established', function (msg) {
      servers.messageDisplay('Connection established')
    })

    // Listen to general subscription start
    // Here you could add code to actually subscribe to fields
    socketHandler.registerMandatory('subscription created', function (msg) {
      servers.messageDisplay('Subscription created')
      socketHandler.subscribeEvent('Result') // Start listening for Result
    })

    // Listen to session start
    socketHandler.registerMandatory('session established', function (msg) {
      servers.messageDisplay('Session established')
      nodeGraphics.initiateNodeTree()

    })

    // Listen to session closure
    socketHandler.registerMandatory('session closed', function (msg) {
      servers.messageDisplay('Session closed')
    })

    // Listen to namespaces
    socketHandler.registerMandatory('namespaces', function (msg) {
      addressSpace.handleNamespaces(msg)
     
      servers.messageDisplay('Receiving namespaces')
    })

    // Listen to datatypes. Needed for method calls
    socketHandler.registerMandatory('datatypes', function (datatypes) {
      methodManager.setDataTypes(datatypes)
      methodGraphics.messageDisplay('Receiving datatypes')
    })

    // Listen to error messages
    socketHandler.registerMandatory('error message', function (msg) {
      console.log(msg.message)
      servers.messageDisplay(msg.message)
      tabGenerator.displayError(msg)
    })

    addressSpace.getTighteningsSystemsPromise().then(
        (tighteningSystemNodes) => { 
          methodManager.setTighteningSystem(tighteningSystemNodes[0]) }
      )

    window.onbeforeunload = function () {
      socket.emit('terminate connection')
      return
    }
  </script>
</body>

</html>